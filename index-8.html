<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Titan Coeus</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{--bg:#f5f5f7;--fg:#1d1d1f;--mid:#6e6e73;--white:#fff;--blue:#0066cc;--serif:'Georgia','Times New Roman',serif;--sans:-apple-system,BlinkMacSystemFont,'SF Pro Display','Helvetica Neue',Arial,sans-serif}
html{scroll-behavior:smooth}
body{font-family:var(--sans);background:var(--bg);color:var(--fg);overflow-x:hidden}
nav{position:fixed;top:0;left:0;right:0;z-index:100;display:flex;align-items:center;justify-content:space-between;padding:0 48px;height:52px;background:rgba(245,245,247,.88);backdrop-filter:saturate(180%) blur(20px);border-bottom:1px solid rgba(0,0,0,.08)}
.nav-brand{font-size:17px;font-weight:600;color:var(--fg);cursor:pointer}
.nav-links{display:flex;gap:32px;align-items:center}
.nav-links a{font-size:14px;color:var(--fg);text-decoration:none;opacity:.8;cursor:pointer;transition:opacity .2s}
.nav-links a:hover{opacity:1}
.page{display:none;min-height:100vh}
.page.active{display:block}
.hero{padding-top:140px;padding-bottom:80px;text-align:center;opacity:0;transform:translateY(24px);animation:fadeUp .9s cubic-bezier(.22,1,.36,1) .1s forwards}
.hero h1{font-family:var(--serif);font-size:clamp(52px,8vw,96px);font-weight:700;letter-spacing:-2.5px;line-height:1.04;margin-bottom:20px}
.hero p{font-size:17px;color:var(--mid);max-width:400px;margin:0 auto;line-height:1.6}
.featured{width:100%;height:74vh;min-height:500px;position:relative;overflow:hidden;cursor:pointer;opacity:0;animation:fadeUp 1s cubic-bezier(.22,1,.36,1) .3s forwards}
.featured-bg{position:absolute;inset:0;background:#0a0a0a}
.featured-img{position:absolute;inset:0;background-size:cover;background-position:center;opacity:.38;transition:opacity .5s,transform .7s cubic-bezier(.22,1,.36,1)}
.featured:hover .featured-img{opacity:.48;transform:scale(1.02)}
.featured-content{position:absolute;inset:0;display:flex;flex-direction:column;justify-content:flex-end;padding:56px 64px}
.featured-label{font-size:11px;font-weight:600;letter-spacing:2.5px;text-transform:uppercase;color:rgba(255,255,255,.45);margin-bottom:14px}
.featured-title{font-family:var(--serif);font-size:clamp(36px,5.5vw,72px);font-weight:700;color:#fff;letter-spacing:-1.5px;line-height:1.06;max-width:700px;margin-bottom:14px}
.featured-desc{font-size:16px;color:rgba(255,255,255,.58);max-width:460px;line-height:1.6;margin-bottom:32px}
.featured-cta{display:inline-flex;align-items:center;gap:8px;font-size:14px;font-weight:500;color:#fff;border:1px solid rgba(255,255,255,.28);padding:10px 22px;border-radius:980px;width:fit-content;transition:background .25s}
.featured:hover .featured-cta{background:rgba(255,255,255,.1)}
.carousel-section{padding:80px 0 40px;opacity:0;animation:fadeUp 1s cubic-bezier(.22,1,.36,1) .5s forwards}
.section-eyebrow{text-align:center;font-size:11px;font-weight:600;letter-spacing:2.5px;text-transform:uppercase;color:var(--mid);margin-bottom:10px}
.section-heading{text-align:center;font-family:var(--serif);font-size:clamp(28px,4vw,46px);font-weight:700;letter-spacing:-1px;margin-bottom:48px}
.carousel-wrap{position:relative;overflow:hidden;padding:20px 0 36px}
.carousel-track{display:flex;align-items:center;gap:24px;transition:transform .52s cubic-bezier(.22,1,.36,1);will-change:transform}
.c-card{flex-shrink:0;width:340px;border-radius:16px;overflow:hidden;cursor:pointer;transition:transform .5s cubic-bezier(.22,1,.36,1),filter .5s,box-shadow .5s;filter:blur(3px) brightness(.65);transform:scale(.84);background:var(--white)}
.c-card.active{filter:none;transform:scale(1);box-shadow:0 28px 72px rgba(0,0,0,.16);z-index:2}
.c-card.near{filter:blur(1.5px) brightness(.8);transform:scale(.92)}
.c-img{width:100%;height:218px;background-size:cover;background-position:center;background-color:#eee}
.c-body{padding:20px 22px 24px}
.c-tag{font-size:10px;font-weight:600;letter-spacing:1.8px;text-transform:uppercase;color:var(--mid);margin-bottom:8px}
.c-title{font-family:var(--serif);font-size:19px;font-weight:700;letter-spacing:-.3px;line-height:1.3;margin-bottom:8px}
.c-desc{font-size:13px;color:var(--mid);line-height:1.55}
.carousel-btn{position:absolute;top:50%;transform:translateY(-50%);width:44px;height:44px;border-radius:50%;background:var(--white);border:1px solid rgba(0,0,0,.1);box-shadow:0 4px 16px rgba(0,0,0,.1);display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:10;transition:box-shadow .2s}
.carousel-btn:hover{box-shadow:0 6px 24px rgba(0,0,0,.15)}
.btn-prev{left:24px}.btn-next{right:24px}
.carousel-dots{display:flex;justify-content:center;gap:8px;margin-top:24px}
.dot{width:6px;height:6px;border-radius:3px;background:#c4c4c6;cursor:pointer;transition:width .3s,background .3s}
.dot.active{width:20px;background:var(--fg)}
.latest-section{padding:80px 64px;max-width:1200px;margin:0 auto;opacity:0;animation:fadeUp 1s cubic-bezier(.22,1,.36,1) .65s forwards}
.posts-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:1px;background:rgba(0,0,0,.08);border:1px solid rgba(0,0,0,.08);border-radius:18px;overflow:hidden}
.post-tile{background:var(--white);padding:28px;display:flex;flex-direction:column;gap:10px;cursor:pointer;transition:background .2s}
.post-tile:hover{background:#fafafa}
.tile-meta{display:flex;gap:12px;align-items:center}
.tile-tag{font-size:10px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--mid)}
.tile-date{font-size:11px;color:#aaa}
.tile-title{font-family:var(--serif);font-size:18px;font-weight:700;letter-spacing:-.3px;line-height:1.3}
.tile-desc{font-size:13px;color:var(--mid);line-height:1.6}
.tile-read{font-size:12px;font-weight:500;color:var(--blue);margin-top:4px}
.view-all-wrap{text-align:center;margin-top:44px}
.view-all{display:inline-flex;align-items:center;gap:6px;font-size:14px;font-weight:500;color:var(--blue);cursor:pointer}
.blogs-hero{padding:120px 64px 40px;max-width:1200px;margin:0 auto}
.blogs-hero h1{font-family:var(--serif);font-size:clamp(36px,5vw,60px);font-weight:700;letter-spacing:-1.5px;margin-bottom:10px}
.blogs-hero p{font-size:17px;color:var(--mid)}
.blogs-list{max-width:1200px;margin:0 auto;padding:0 64px 40px}
.blog-row{display:grid;grid-template-columns:52px 1fr auto;align-items:start;gap:24px;padding:28px 0;border-bottom:1px solid rgba(0,0,0,.07);cursor:pointer}
.blog-row:first-child{border-top:1px solid rgba(0,0,0,.07)}
.blog-num{font-size:13px;color:#bbb;padding-top:3px}
.blog-row-title{font-family:var(--serif);font-size:20px;font-weight:700;letter-spacing:-.3px;margin-bottom:7px;transition:color .2s}
.blog-row:hover .blog-row-title{color:var(--blue)}
.blog-row-desc{font-size:14px;color:var(--mid);line-height:1.6}
.blog-row-tag{font-size:10px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--mid);white-space:nowrap;padding-top:4px}
.pagination{display:flex;align-items:center;justify-content:center;gap:8px;padding:40px 0 20px}
.pg-btn{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:500;cursor:pointer;border:1px solid transparent;transition:all .2s;background:none;color:var(--fg);font-family:var(--sans)}
.pg-btn.active{background:var(--fg);color:#fff}
.pg-btn:hover:not(.active){border-color:rgba(0,0,0,.15)}
.pg-next{width:auto;padding:0 16px;border-radius:980px}
.post-page{max-width:720px;margin:0 auto;padding:120px 32px 80px}
.post-back{display:inline-flex;align-items:center;gap:6px;font-size:14px;color:var(--mid);cursor:pointer;margin-bottom:40px;transition:color .2s}
.post-back:hover{color:var(--fg)}
.post-tag-label{font-size:11px;font-weight:600;letter-spacing:2px;text-transform:uppercase;color:var(--mid);margin-bottom:16px}
.post-title{font-family:var(--serif);font-size:clamp(32px,5vw,52px);font-weight:700;letter-spacing:-1.5px;line-height:1.1;margin-bottom:16px}
.post-meta{font-size:13px;color:var(--mid);margin-bottom:48px;padding-bottom:32px;border-bottom:1px solid rgba(0,0,0,.1)}
.post-body{font-size:18px;line-height:1.75}
.post-body p{margin-bottom:24px}
.post-body h2{font-family:var(--serif);font-size:28px;font-weight:700;margin:40px 0 16px}
.post-body h3{font-family:var(--serif);font-size:22px;font-weight:700;margin:32px 0 12px}
.post-body blockquote{border-left:3px solid var(--fg);padding-left:24px;margin:32px 0;font-style:italic;color:var(--mid)}
.contact-section{max-width:600px;margin:0 auto;padding:120px 48px 80px;text-align:center}
.contact-section h1{font-family:var(--serif);font-size:clamp(32px,5vw,56px);font-weight:700;letter-spacing:-1.5px;margin-bottom:14px}
.contact-section>p{font-size:17px;color:var(--mid);margin-bottom:48px;line-height:1.6}
.contact-form{display:flex;flex-direction:column;gap:16px;text-align:left}
.form-group label{font-size:13px;font-weight:500;display:block;margin-bottom:6px}
.form-group input,.form-group textarea{width:100%;padding:12px 16px;border:1px solid rgba(0,0,0,.15);border-radius:10px;font-family:var(--sans);font-size:15px;background:var(--white);color:var(--fg);outline:none;transition:border-color .2s}
.form-group input:focus,.form-group textarea:focus{border-color:var(--blue)}
.form-group textarea{min-height:140px;resize:vertical}
.submit-btn{background:var(--fg);color:#fff;padding:14px 32px;border-radius:980px;border:none;font-size:15px;font-weight:500;cursor:pointer;transition:opacity .2s;align-self:center;font-family:var(--sans)}
.submit-btn:hover{opacity:.82}
.submit-btn:disabled{opacity:.5;cursor:not-allowed}
footer{border-top:1px solid rgba(0,0,0,.1);padding:48px 64px 36px;margin-top:80px}
.footer-inner{max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:32px}
.footer-brand{font-size:17px;font-weight:600;margin-bottom:8px}
.footer-tagline{font-size:13px;color:var(--mid);max-width:240px;line-height:1.5}
.footer-links{display:flex;gap:48px}
.footer-col h4{font-size:12px;font-weight:600;margin-bottom:12px}
.footer-col a{display:block;font-size:13px;color:var(--mid);text-decoration:none;margin-bottom:8px;cursor:pointer;transition:color .2s}
.footer-col a:hover{color:var(--fg)}
.footer-bottom{max-width:1200px;margin:28px auto 0;padding-top:20px;border-top:1px solid rgba(0,0,0,.08);display:flex;justify-content:space-between;font-size:12px;color:#aaa}
.loading{display:flex;justify-content:center;padding:60px}
.spinner{width:28px;height:28px;border:2px solid rgba(0,0,0,.1);border-top-color:var(--fg);border-radius:50%;animation:spin .7s linear infinite}
.empty-state{text-align:center;padding:80px 32px;color:var(--mid);font-size:16px}
.login-wrap{max-width:400px;margin:0 auto;padding:140px 32px 80px;text-align:center}
.login-wrap h1{font-family:var(--serif);font-size:36px;font-weight:700;letter-spacing:-1px;margin-bottom:8px}
.login-wrap>p{color:var(--mid);font-size:15px;margin-bottom:40px}
.login-form{display:flex;flex-direction:column;gap:14px;text-align:left}
.err-msg{color:#ff3b30;font-size:13px;text-align:center;margin-top:4px}
.admin-wrap{max-width:1100px;margin:0 auto;padding:80px 48px}
.admin-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:48px;padding-top:20px}
.admin-title{font-family:var(--serif);font-size:32px;font-weight:700;letter-spacing:-1px}
.admin-actions{display:flex;gap:12px}
.btn-primary{background:var(--fg);color:#fff;border:none;padding:10px 22px;border-radius:980px;font-size:14px;font-weight:500;cursor:pointer;font-family:var(--sans)}
.btn-secondary{background:none;border:1px solid rgba(0,0,0,.15);padding:10px 22px;border-radius:980px;font-size:14px;cursor:pointer;font-family:var(--sans)}
.posts-table{border:1px solid rgba(0,0,0,.08);border-radius:14px;overflow:hidden}
.admin-row{display:grid;grid-template-columns:1fr auto auto;gap:24px;align-items:center;padding:20px 24px;background:#fff;border-bottom:1px solid rgba(0,0,0,.07)}
.admin-row:last-child{border-bottom:none}
.admin-row-title{font-weight:600;font-size:16px;margin-bottom:4px}
.admin-row-meta{font-size:12px;color:var(--mid)}
.s-published{color:#30a46c;font-weight:500}
.s-draft{color:#f59e0b;font-weight:500}
.btn-edit{background:none;border:1px solid rgba(0,0,0,.12);padding:8px 18px;border-radius:980px;font-size:13px;cursor:pointer;font-family:var(--sans)}
.btn-del{background:none;border:1px solid #ff3b30;color:#ff3b30;padding:8px 18px;border-radius:980px;font-size:13px;cursor:pointer;font-family:var(--sans)}
.editor-wrap{max-width:800px;margin:0 auto;padding:80px 48px 120px}
.editor-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:40px;padding-top:20px}
.editor-title{font-family:var(--serif);font-size:28px;font-weight:700;letter-spacing:-.8px}
.editor-form{display:flex;flex-direction:column;gap:20px}
.editor-actions{display:flex;gap:12px;justify-content:flex-end;margin-top:8px}
.save-msg{text-align:center;font-size:13px;color:var(--mid)}
@keyframes fadeUp{to{opacity:1;transform:translateY(0)}}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>

<nav>
  <span class="nav-brand" id="navHome">Titan Coeus</span>
  <div class="nav-links">
    <a id="navHomeLink">Home</a>
    <a id="navBlogs">Blogs</a>
    <a id="navContact">Contact</a>
    <a id="navAdmin" style="opacity:.4;font-size:12px">Admin</a>
  </div>
</nav>

<!-- HOME -->
<div id="page-home" class="page active">
  <section class="hero"><h1>Clarity in thought.</h1><p>Exploring ideas at the intersection of technology, philosophy, and the future.</p></section>
  <div id="featuredWrap">
    <div id="featuredLoading" class="loading"><div class="spinner"></div></div>
    <section class="featured" id="featuredSection" style="display:none">
      <div class="featured-bg"></div>
      <div class="featured-img" id="featuredImg"></div>
      <div class="featured-content">
        <div class="featured-label">Latest Essay</div>
        <h2 class="featured-title" id="featuredTitle"></h2>
        <p class="featured-desc" id="featuredDesc"></p>
        <div class="featured-cta">Read the essay →</div>
      </div>
    </section>
  </div>
  <section id="carouselSection" style="display:none" class="carousel-section">
    <div class="section-eyebrow">The Archive</div>
    <h2 class="section-heading">Recent Writings</h2>
    <div class="carousel-wrap" id="carouselWrap">
      <button class="carousel-btn btn-prev" id="carouselPrev"><svg width="18" height="18" viewBox="0 0 18 18" fill="none"><path d="M11 4l-5 5 5 5" stroke="#1d1d1f" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
      <div class="carousel-track" id="carouselTrack"></div>
      <button class="carousel-btn btn-next" id="carouselNext"><svg width="18" height="18" viewBox="0 0 18 18" fill="none"><path d="M7 4l5 5-5 5" stroke="#1d1d1f" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
    </div>
    <div class="carousel-dots" id="carouselDots"></div>
  </section>
  <section class="latest-section" id="latestSection" style="display:none">
    <div class="section-eyebrow">Latest</div>
    <h2 class="section-heading" style="text-align:left;margin-bottom:28px">From the desk</h2>
    <div class="posts-grid" id="latestGrid"></div>
    <div class="view-all-wrap"><span class="view-all" id="viewAll">View all writings →</span></div>
  </section>
  <footer>
    <div class="footer-inner">
      <div><div class="footer-brand">Titan Coeus</div><p class="footer-tagline">Writing at the intersection of technology, philosophy, and the future.</p></div>
      <div class="footer-links">
        <div class="footer-col"><h4>Navigate</h4><a id="f1">Home</a><a id="f2">All Writings</a><a id="f3">Contact</a></div>
        <div class="footer-col"><h4>Topics</h4><a>Artificial Intelligence</a><a>Philosophy</a><a>Technology</a><a>Future Studies</a></div>
      </div>
    </div>
    <div class="footer-bottom"><span>© 2025 Titan Coeus.</span><span>Built with clarity of thought.</span></div>
  </footer>
</div>

<!-- BLOGS -->
<div id="page-blogs" class="page">
  <div class="blogs-hero"><h1>All Writings</h1><p>Essays on AI, philosophy, technology, and the nature of intelligence.</p></div>
  <div class="blogs-list" id="blogsList"><div class="loading"><div class="spinner"></div></div></div>
  <div class="pagination" id="pagination"></div>
  <footer><div class="footer-inner"><div><div class="footer-brand">Titan Coeus</div></div></div><div class="footer-bottom"><span>© 2025 Titan Coeus.</span></div></footer>
</div>

<!-- POST -->
<div id="page-post" class="page">
  <div class="post-page">
    <div class="post-back" id="postBack">← Back</div>
    <div class="post-tag-label" id="postTag"></div>
    <h1 class="post-title" id="postTitle"></h1>
    <div class="post-meta" id="postMeta"></div>
    <div class="post-body" id="postBody"></div>
  </div>
  <footer><div class="footer-inner"><div><div class="footer-brand">Titan Coeus</div></div></div><div class="footer-bottom"><span>© 2025 Titan Coeus.</span></div></footer>
</div>

<!-- CONTACT -->
<div id="page-contact" class="page">
  <div class="contact-section">
    <h1>Get in touch.</h1>
    <p>Have a thought to share, a question to ask, or just want to connect?</p>
    <div class="contact-form">
      <div class="form-group"><label>Name</label><input type="text" placeholder="Your name"/></div>
      <div class="form-group"><label>Email</label><input type="email" placeholder="your@email.com"/></div>
      <div class="form-group"><label>Message</label><textarea placeholder="What's on your mind?"></textarea></div>
      <button class="submit-btn">Send message</button>
    </div>
  </div>
  <footer><div class="footer-inner"><div><div class="footer-brand">Titan Coeus</div></div></div><div class="footer-bottom"><span>© 2025 Titan Coeus.</span></div></footer>
</div>

<!-- LOGIN -->
<div id="page-login" class="page">
  <div class="login-wrap">
    <h1>Admin</h1>
    <p>Sign in to manage your blog.</p>
    <div class="login-form">
      <div class="form-group"><label>Email</label><input type="email" id="loginEmail" placeholder="your@email.com"/></div>
      <div class="form-group"><label>Password</label><input type="password" id="loginPass" placeholder="••••••••"/></div>
      <button class="submit-btn" id="loginBtn">Sign in</button>
      <p class="err-msg" id="loginErr" style="display:none"></p>
    </div>
  </div>
</div>

<!-- ADMIN -->
<div id="page-admin" class="page">
  <div class="admin-wrap">
    <div class="admin-header">
      <div class="admin-title">Dashboard</div>
      <div class="admin-actions">
        <button class="btn-primary" id="newPostBtn">+ New Essay</button>
        <button class="btn-secondary" id="logoutBtn">Sign out</button>
      </div>
    </div>
    <div id="adminList"><div class="loading"><div class="spinner"></div></div></div>
  </div>
</div>

<!-- EDITOR -->
<div id="page-newpost" class="page">
  <div class="editor-wrap">
    <div class="editor-header">
      <div class="editor-title" id="editorHeading">New Essay</div>
      <button class="btn-secondary" id="editorBack">← Back</button>
    </div>
    <div class="editor-form">
      <div class="form-group"><label>Title</label><input type="text" id="eTitle" placeholder="The Architecture of Intelligence"/></div>
      <div class="form-group"><label>Short Description</label><input type="text" id="eDesc" placeholder="A brief description..."/></div>
      <div class="form-group"><label>Tag</label><input type="text" id="eTag" placeholder="AI, Philosophy, Technology..."/></div>
      <div class="form-group"><label>Cover Image URL</label><input type="text" id="eImg" placeholder="https://images.unsplash.com/..."/></div>
      <div class="form-group"><label>Content <span style="color:var(--mid);font-weight:400">(HTML: &lt;p&gt; &lt;h2&gt; &lt;blockquote&gt;)</span></label><textarea id="eContent" style="min-height:400px;font-family:monospace;font-size:13px" placeholder="<p>Your essay begins here...</p>"></textarea></div>
      <div class="editor-actions">
        <button class="btn-secondary" id="saveDraftBtn">Save Draft</button>
        <button class="btn-primary" id="publishBtn">Publish →</button>
      </div>
      <p class="save-msg" id="saveMsg"></p>
    </div>
  </div>
</div>

<script src="config.js"></script>
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
import { getFirestore, collection, addDoc, getDocs, getDoc, doc, updateDoc, deleteDoc, query, orderBy, where, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

const app = initializeApp(FIREBASE_CONFIG);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
let allPosts = [];
let carouselIdx = 0;
let prevPage = 'home';
let editId = null;
let blogPage = 1;
const PER_PAGE = 20;

// ── SHOW PAGE ──
function showPage(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-'+id).classList.add('active');
  window.scrollTo({top:0,behavior:'smooth'});
}

// ── NAV WIRING ──
document.getElementById('navHome').onclick = () => showPage('home');
document.getElementById('navHomeLink').onclick = () => showPage('home');
document.getElementById('navBlogs').onclick = () => { showPage('blogs'); loadBlogs(); };
document.getElementById('navContact').onclick = () => showPage('contact');
document.getElementById('navAdmin').onclick = () => {
  if (currentUser && currentUser.email === ADMIN_EMAIL) { showPage('admin'); loadAdmin(); }
  else showPage('login');
};
document.getElementById('viewAll').onclick = () => { showPage('blogs'); loadBlogs(); };
document.getElementById('f1').onclick = () => showPage('home');
document.getElementById('f2').onclick = () => { showPage('blogs'); loadBlogs(); };
document.getElementById('f3').onclick = () => showPage('contact');
document.getElementById('postBack').onclick = () => showPage(prevPage);
document.getElementById('newPostBtn').onclick = () => { clearEditor(); showPage('newpost'); };
document.getElementById('editorBack').onclick = () => { showPage('admin'); loadAdmin(); };
document.getElementById('saveDraftBtn').onclick = () => savePost('draft');
document.getElementById('publishBtn').onclick = () => savePost('published');
document.getElementById('carouselPrev').onclick = () => { carouselIdx = Math.max(0, carouselIdx-1); updateCarousel(); };
document.getElementById('carouselNext').onclick = () => { const n = document.querySelectorAll('.c-card').length; carouselIdx = Math.min(n-1, carouselIdx+1); updateCarousel(); };
window.addEventListener('resize', updateCarousel);

// ── AUTH ──
onAuthStateChanged(auth, user => {
  currentUser = user;
  const link = document.getElementById('navAdmin');
  if (user && user.email === ADMIN_EMAIL) { link.textContent = 'Dashboard'; }
  else { link.textContent = 'Admin'; }
});

// ── LOGIN ──
async function doSignIn() {
  const email = document.getElementById('loginEmail').value.trim();
  const pass = document.getElementById('loginPass').value;
  const err = document.getElementById('loginErr');
  const btn = document.getElementById('loginBtn');
  err.style.display = 'none';
  btn.textContent = 'Signing in...';
  btn.disabled = true;
  try {
    const cred = await signInWithEmailAndPassword(auth, email, pass);
    currentUser = cred.user;
    btn.textContent = 'Sign in';
    btn.disabled = false;
    showPage('admin');
    await loadAdmin();
  } catch(e) {
    btn.textContent = 'Sign in';
    btn.disabled = false;
    err.textContent = 'Wrong email or password.';
    err.style.display = 'block';
  }
}
document.getElementById('loginBtn').addEventListener('click', doSignIn);
document.getElementById('loginPass').addEventListener('keydown', e => { if(e.key==='Enter') doSignIn(); });

// ── LOGOUT ──
document.getElementById('logoutBtn').addEventListener('click', async () => {
  await signOut(auth);
  currentUser = null;
  showPage('home');
});

// ── FETCH POSTS ──
async function fetchPosts(all=false) {
  try {
    const q = all
      ? query(collection(db,'posts'), orderBy('createdAt','desc'))
      : query(collection(db,'posts'), where('status','==','published'), orderBy('createdAt','desc'));
    const snap = await getDocs(q);
    return snap.docs.map(d => ({id:d.id,...d.data()}));
  } catch(e) { console.error('fetchPosts error:', e); return []; }
}

// ── HOME ──
async function loadHome() {
  const posts = await fetchPosts(false);
  allPosts = posts;
  document.getElementById('featuredLoading').style.display = 'none';
  if (!posts.length) return;
  const f = posts[0];
  document.getElementById('featuredTitle').textContent = f.title;
  document.getElementById('featuredDesc').textContent = f.description || '';
  if (f.coverImage) document.getElementById('featuredImg').style.backgroundImage = `url('${f.coverImage}')`;
  document.getElementById('featuredSection').style.display = 'block';
  document.getElementById('featuredSection').onclick = () => openPost(f.id);
  if (posts.length > 1) { buildCarousel(posts.slice(1,6)); document.getElementById('carouselSection').style.display = 'block'; }
  buildLatestGrid(posts.slice(0,6));
  document.getElementById('latestSection').style.display = 'block';
}

// ── CAROUSEL ──
function buildCarousel(posts) {
  const track = document.getElementById('carouselTrack');
  const dots = document.getElementById('carouselDots');
  track.innerHTML = ''; dots.innerHTML = ''; carouselIdx = 0;
  posts.forEach((p,i) => {
    const card = document.createElement('div');
    card.className = 'c-card'+(i===0?' active':'');
    card.addEventListener('click', () => { if(i===carouselIdx) openPost(p.id); else { carouselIdx=i; updateCarousel(); }});
    card.innerHTML = `<div class="c-img" style="background-image:url('${p.coverImage||''}')"></div><div class="c-body"><div class="c-tag">${p.tag||''}</div><div class="c-title">${p.title}</div><div class="c-desc">${p.description||''}</div></div>`;
    track.appendChild(card);
    const dot = document.createElement('div');
    dot.className = 'dot'+(i===0?' active':'');
    dot.addEventListener('click', () => { carouselIdx=i; updateCarousel(); });
    dots.appendChild(dot);
  });
  updateCarousel();
}

function updateCarousel() {
  const track = document.getElementById('carouselTrack');
  const cards = [...track.querySelectorAll('.c-card')];
  if (!cards.length) return;
  const wrap = document.getElementById('carouselWrap');
  track.style.transform = `translateX(${wrap.offsetWidth/2-170-carouselIdx*364}px)`;
  cards.forEach((c,i) => { c.classList.remove('active','near'); if(i===carouselIdx) c.classList.add('active'); else if(Math.abs(i-carouselIdx)===1) c.classList.add('near'); });
  document.querySelectorAll('.dot').forEach((d,i) => d.classList.toggle('active',i===carouselIdx));
}

// ── LATEST GRID ──
function buildLatestGrid(posts) {
  const grid = document.getElementById('latestGrid');
  grid.innerHTML = '';
  posts.forEach(p => {
    const t = document.createElement('div');
    t.className = 'post-tile';
    t.addEventListener('click', () => openPost(p.id));
    t.innerHTML = `<div class="tile-meta"><span class="tile-tag">${p.tag||''}</span><span class="tile-date">${fmtDate(p.createdAt)}</span></div><div class="tile-title">${p.title}</div><div class="tile-desc">${p.description||''}</div><span class="tile-read">Read essay →</span>`;
    grid.appendChild(t);
  });
}

// ── BLOGS ──
async function loadBlogs(page=1) {
  blogPage = page;
  const list = document.getElementById('blogsList');
  list.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  if (!allPosts.length) allPosts = await fetchPosts(false);
  list.innerHTML = '';
  if (!allPosts.length) { list.innerHTML = '<div class="empty-state">No essays published yet.</div>'; return; }
  const slice = allPosts.slice((page-1)*PER_PAGE, page*PER_PAGE);
  slice.forEach((p,i) => {
    const row = document.createElement('div');
    row.className = 'blog-row';
    row.addEventListener('click', () => openPost(p.id));
    row.innerHTML = `<div class="blog-num">${String((page-1)*PER_PAGE+i+1).padStart(2,'0')}</div><div><div class="blog-row-title">${p.title}</div><div class="blog-row-desc">${p.description||''}</div></div><div class="blog-row-tag">${p.tag||''}</div>`;
    list.appendChild(row);
  });
  const pag = document.getElementById('pagination');
  pag.innerHTML = '';
  const total = Math.ceil(allPosts.length/PER_PAGE);
  for(let i=1;i<=total;i++){const b=document.createElement('button');b.className='pg-btn'+(i===page?' active':'');b.textContent=i;b.addEventListener('click',()=>loadBlogs(i));pag.appendChild(b);}
  if(page<total){const b=document.createElement('button');b.className='pg-btn pg-next';b.textContent='Next →';b.addEventListener('click',()=>loadBlogs(page+1));pag.appendChild(b);}
}

// ── SINGLE POST ──
async function openPost(id) {
  prevPage = document.querySelector('.page.active')?.id?.replace('page-','') || 'home';
  showPage('post');
  document.getElementById('postBody').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  try {
    const snap = await getDoc(doc(db,'posts',id));
    if (!snap.exists()) return;
    const p = {id:snap.id,...snap.data()};
    document.getElementById('postTag').textContent = p.tag||'';
    document.getElementById('postTitle').textContent = p.title;
    document.getElementById('postMeta').textContent = `${fmtDate(p.createdAt)} · ${Math.max(1,Math.round((p.content||'').replace(/<[^>]+>/g,'').split(/\s+/).length/200))} min read`;
    document.getElementById('postBody').innerHTML = p.content||'';
  } catch(e) { document.getElementById('postBody').innerHTML = '<p>Error loading post.</p>'; }
}

// ── ADMIN ──
async function loadAdmin() {
  const list = document.getElementById('adminList');
  list.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  const posts = await fetchPosts(true);
  list.innerHTML = '';
  if (!posts.length) { list.innerHTML = '<div class="empty-state">No essays yet. Write your first one!</div>'; return; }
  const table = document.createElement('div');
  table.className = 'posts-table';
  posts.forEach(p => {
    const row = document.createElement('div');
    row.className = 'admin-row';
    row.innerHTML = `<div><div class="admin-row-title">${p.title}</div><div class="admin-row-meta">${fmtDate(p.createdAt)} · <span class="s-${p.status||'draft'}">${p.status||'draft'}</span></div></div><button class="btn-edit">Edit</button><button class="btn-del">Delete</button>`;
    row.querySelector('.btn-edit').addEventListener('click', async () => {
      editId = p.id;
      document.getElementById('eTitle').value = p.title||'';
      document.getElementById('eDesc').value = p.description||'';
      document.getElementById('eTag').value = p.tag||'';
      document.getElementById('eImg').value = p.coverImage||'';
      document.getElementById('eContent').value = p.content||'';
      document.getElementById('editorHeading').textContent = 'Edit Essay';
      showPage('newpost');
    });
    row.querySelector('.btn-del').addEventListener('click', async (e) => {
      if (!confirm('Delete this essay?')) return;
      e.target.textContent = '...';
      await deleteDoc(doc(db,'posts',p.id));
      allPosts = [];
      loadAdmin();
    });
    table.appendChild(row);
  });
  list.appendChild(table);
}

// ── SAVE POST ──
async function savePost(status) {
  const title = document.getElementById('eTitle').value.trim();
  if (!title) { alert('Please add a title.'); return; }
  const data = {title, description:document.getElementById('eDesc').value.trim(), tag:document.getElementById('eTag').value.trim(), coverImage:document.getElementById('eImg').value.trim(), content:document.getElementById('eContent').value.trim(), status, updatedAt:serverTimestamp()};
  const msg = document.getElementById('saveMsg');
  try {
    if (editId) { await updateDoc(doc(db,'posts',editId), data); }
    else { data.createdAt = serverTimestamp(); await addDoc(collection(db,'posts'), data); }
    allPosts = [];
    msg.textContent = status==='published'?'✓ Published!':'✓ Saved as draft.';
    setTimeout(() => { clearEditor(); showPage('admin'); loadAdmin(); }, 1000);
  } catch(e) { alert('Error: '+e.message); }
}

function clearEditor() {
  ['eTitle','eDesc','eTag','eImg','eContent'].forEach(id => document.getElementById(id).value='');
  document.getElementById('editorHeading').textContent = 'New Essay';
  document.getElementById('saveMsg').textContent = '';
  editId = null;
}

// ── HELPERS ──
function fmtDate(ts) {
  if(!ts) return '';
  try { const d=ts.toDate?ts.toDate():new Date(ts); return d.toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'}); }
  catch(e) { return ''; }
}

// ── INIT ──
loadHome();
</script>
</body>
</html>
